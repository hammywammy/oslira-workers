name = "oslira-workers"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# ===========================
# KV NAMESPACE
# ===========================
[[kv_namespaces]]
binding = "OSLIRA_KV"
id = "dd86f413c4374811ac253bb9a6567182"

# ===========================
# R2 BUCKET
# ===========================
[[r2_buckets]]
binding = "R2_CACHE_BUCKET"
bucket_name = "oslira-cache"

# ===========================
# ANALYTICS ENGINE
# ===========================
[[analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"

# ===========================
# WORKFLOWS
# ===========================
[[workflows]]
binding = "ANALYSIS_WORKFLOW"
name = "analysis-workflow"
class_name = "AnalysisWorkflow"

[[workflows]]
binding = "BUSINESS_CONTEXT_WORKFLOW"
name = "business-context-workflow"
class_name = "BusinessContextWorkflow"

# ===========================
# DURABLE OBJECTS
# ===========================
[[durable_objects.bindings]]
name = "ANALYSIS_PROGRESS"
class_name = "AnalysisProgressDO"
script_name = "oslira-workers"

[[durable_objects.bindings]]
name = "BUSINESS_CONTEXT_PROGRESS"
class_name = "BusinessContextProgressDO"
script_name = "oslira-workers"

# ===========================
# DURABLE OBJECTS MIGRATIONS
# ===========================
[[migrations]]
tag = "v1"
new_classes = ["AnalysisProgressDO"]

[[migrations]]
tag = "v2"
new_classes = ["BusinessContextProgressDO"]

# ===========================
# QUEUES
# ===========================
[[queues.producers]]
binding = "STRIPE_WEBHOOK_QUEUE"
queue = "stripe-webhooks"

[[queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "analysis-jobs"

[[queues.producers]]
binding = "BUSINESS_CONTEXT_QUEUE"
queue = "business-context-jobs"

[[queues.consumers]]
queue = "stripe-webhooks"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "stripe-webhooks-dlq"

[[queues.consumers]]
queue = "analysis-jobs"
max_batch_size = 1
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "analysis-jobs-dlq"

[[queues.consumers]]
queue = "business-context-jobs"
max_batch_size = 1        # ✅ Process immediately (no batching needed for onboarding)
max_batch_timeout = 5     # ✅ 5 seconds max wait (safety net)
max_retries = 3
dead_letter_queue = "business-context-jobs-dlq"


# ===========================
# CRON TRIGGERS
# ===========================
[triggers]
crons = [
  "0 3 1 * *",   # Monthly renewal (1st of month, 3 AM UTC)
  "0 2 * * *",   # Daily cleanup (2 AM UTC)
  "0 * * * *"    # Hourly failed analysis cleanup
]

# ===========================
# STAGING ENVIRONMENT
# ===========================
[env.staging]
name = "oslira-workers-staging"

[[env.staging.kv_namespaces]]
binding = "OSLIRA_KV"
id = "dd86f413c4374811ac253bb9a6567182"

[[env.staging.r2_buckets]]
binding = "R2_CACHE_BUCKET"
bucket_name = "oslira-cache"

[[env.staging.analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"

[[env.staging.workflows]]
binding = "ANALYSIS_WORKFLOW"
name = "analysis-workflow-staging"
class_name = "AnalysisWorkflow"

[[env.staging.workflows]]
binding = "BUSINESS_CONTEXT_WORKFLOW"
name = "business-context-workflow-staging"
class_name = "BusinessContextWorkflow"

[[env.staging.durable_objects.bindings]]
name = "ANALYSIS_PROGRESS"
class_name = "AnalysisProgressDO"
script_name = "oslira-workers-staging"

[[env.staging.durable_objects.bindings]]
name = "BUSINESS_CONTEXT_PROGRESS"
class_name = "BusinessContextProgressDO"
script_name = "oslira-workers-staging"

[[env.staging.queues.producers]]
binding = "STRIPE_WEBHOOK_QUEUE"
queue = "stripe-webhooks-staging"

[[env.staging.queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "analysis-jobs-staging"

[[env.staging.queues.producers]]
binding = "BUSINESS_CONTEXT_QUEUE"
queue = "business-context-jobs-staging"

[env.staging.triggers]
crons = [
  "0 4 1 * *",
  "0 3 * * *",
  "0 * * * *"
]

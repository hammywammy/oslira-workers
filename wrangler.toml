name = "oslira-workers"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# ===========================
# PRODUCTION ENVIRONMENT VARIABLE
# ===========================
[vars]
APP_ENV = "production"
FRONTEND_URL = "https://app.oslira.com"
CLOUDFLARE_ACCOUNT_ID = "ec3a04af3fca5fbb10ec831616e63cfc"
AI_GATEWAY_NAME = "oslira-gateway"

# ===========================
# KV NAMESPACE
# ===========================
[[kv_namespaces]]
binding = "OSLIRA_KV"
id = "dd86f413c4374811ac253bb9a6567182"

# ===========================
# R2 BUCKET
# ===========================
[[r2_buckets]]
binding = "R2_CACHE_BUCKET"
bucket_name = "oslira-cache"

[[r2_buckets]]
binding = "R2_MEDIA_BUCKET"
bucket_name = "oslira-media"

# ===========================
# ANALYTICS ENGINE
# ===========================
[[analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"

# ===========================
# WORKFLOWS
# ===========================
[[workflows]]
binding = "ANALYSIS_WORKFLOW"
name = "analysis-workflow"
class_name = "AnalysisWorkflow"

[[workflows]]
binding = "BUSINESS_CONTEXT_WORKFLOW"
name = "business-context-workflow"
class_name = "BusinessContextWorkflow"

# ===========================
# DURABLE OBJECTS
# ===========================
[[durable_objects.bindings]]
name = "ANALYSIS_PROGRESS"
class_name = "AnalysisProgressDO"
script_name = "oslira-workers"

[[durable_objects.bindings]]
name = "BUSINESS_CONTEXT_PROGRESS"
class_name = "BusinessContextProgressDO"
script_name = "oslira-workers"

# ===========================
# DURABLE OBJECTS MIGRATIONS
# ===========================
[[migrations]]
tag = "v1"
new_classes = ["AnalysisProgressDO"]

[[migrations]]
tag = "v2"
new_classes = ["BusinessContextProgressDO"]

# ===========================
# QUEUES
# ===========================

# PRODUCERS
[[queues.producers]]
binding = "STRIPE_WEBHOOK_QUEUE"
queue = "stripe-webhooks"

[[queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "analysis-jobs"

[[queues.producers]]
binding = "BUSINESS_CONTEXT_QUEUE"
queue = "business-context-jobs"

# CONSUMERS
[[queues.consumers]]
queue = "stripe-webhooks"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "stripe-webhooks-dlq"

[[queues.consumers]]
queue = "analysis-jobs"
max_batch_size = 1
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "analysis-jobs-dlq"

[[queues.consumers]]
queue = "business-context-jobs"
max_batch_size = 1
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "business-context-jobs-dlq"

# ===========================
# CRON TRIGGERS (PRODUCTION ONLY)
# ===========================
# NOTE: Cron triggers run ONLY in production because prod and staging
# share the same database. Running crons in both would cause duplicate
# operations (double credit resets, double cleanups, etc).
[triggers]
crons = [
  "0 0 * * *",   # Daily free plan credit reset (midnight UTC)
  "0 3 1 * *",   # Monthly renewal (1st of month, 3 AM UTC)
  "0 2 * * *",   # Daily cleanup (2 AM UTC)
  "0 * * * *"    # Hourly failed analysis cleanup
]

# ===========================
# STAGING ENVIRONMENT
# ===========================
[env.staging]
name = "oslira-workers-staging"

[env.staging.vars]
APP_ENV = "staging"
FRONTEND_URL = "https://staging-app.oslira.com"
CLOUDFLARE_ACCOUNT_ID = "ec3a04af3fca5fbb10ec831616e63cfc"
AI_GATEWAY_NAME = "oslira-gateway-staging"

# ===========================
# STAGING: CUSTOM DOMAIN
# ===========================
[[env.staging.routes]]
pattern = "api-staging.oslira.com"
custom_domain = true

# ===========================
# STAGING: KV NAMESPACE
# ===========================
[[env.staging.kv_namespaces]]
binding = "OSLIRA_KV"
id = "dd86f413c4374811ac253bb9a6567182"

# ===========================
# STAGING: R2 BUCKETS
# ===========================
[[env.staging.r2_buckets]]
binding = "R2_CACHE_BUCKET"
bucket_name = "oslira-cache"

[[env.staging.r2_buckets]]
binding = "R2_MEDIA_BUCKET"
bucket_name = "oslira-media"

# ===========================
# STAGING: ANALYTICS ENGINE
# ===========================
[[env.staging.analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"

# ===========================
# STAGING: WORKFLOWS
# ===========================
[[env.staging.workflows]]
binding = "ANALYSIS_WORKFLOW"
name = "analysis-workflow-staging"
class_name = "AnalysisWorkflow"

[[env.staging.workflows]]
binding = "BUSINESS_CONTEXT_WORKFLOW"
name = "business-context-workflow-staging"
class_name = "BusinessContextWorkflow"

# ===========================
# STAGING: DURABLE OBJECTS
# ===========================
[[env.staging.durable_objects.bindings]]
name = "ANALYSIS_PROGRESS"
class_name = "AnalysisProgressDO"
script_name = "oslira-workers-staging"

[[env.staging.durable_objects.bindings]]
name = "BUSINESS_CONTEXT_PROGRESS"
class_name = "BusinessContextProgressDO"
script_name = "oslira-workers-staging"

# ===========================
# STAGING: QUEUE PRODUCERS
# ===========================
[[env.staging.queues.producers]]
binding = "STRIPE_WEBHOOK_QUEUE"
queue = "stripe-webhooks-staging"

[[env.staging.queues.producers]]
binding = "ANALYSIS_QUEUE"
queue = "analysis-jobs-staging"

[[env.staging.queues.producers]]
binding = "BUSINESS_CONTEXT_QUEUE"
queue = "business-context-jobs-staging"

# ===========================
# STAGING: QUEUE CONSUMERS
# ===========================
[[env.staging.queues.consumers]]
queue = "stripe-webhooks-staging"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "stripe-webhooks-dlq-staging"

[[env.staging.queues.consumers]]
queue = "analysis-jobs-staging"
max_batch_size = 1
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "analysis-jobs-dlq-staging"

[[env.staging.queues.consumers]]
queue = "business-context-jobs-staging"
max_batch_size = 1
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "business-context-jobs-dlq-staging"

# NOTE: Cron triggers are DISABLED in staging because production and staging
# share the same database. Running crons in both environments would cause:
# - Duplicate credit resets for free plan users
# - Duplicate monthly renewals
# - Conflicting cleanup operations
# All cron jobs run only in production.
# [env.staging.triggers]
# crons = []
